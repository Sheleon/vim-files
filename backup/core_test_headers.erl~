-module(core_test_headers).
-behaviour(cowboy_http_handler).
-export([init/3, handle/2, terminate/2, tests/0]).

init({_Any, http}, Req, []) ->
    {ok, Req, undefined}.

handle(Req, State) ->
    TestHeader = case cowboy_http_req:header(<<"X-Winamp-Id">>, Req) of
        {undefined, _} -> <<"no X-Winamp-ID header sent">>;
        {X, _} -> X
    end,
    {ok, Reply} = cowboy_http_req:reply(200, [], [<<"X-Winamp-ID: ">>, TestHeader], Req),
    {ok, Reply, State}.

terminate(_Req, _State) ->
    ok.

tests() ->
    {tests, [
        test_basic_header(),
        {maximum_header_length, "not implemented"},
        {accept_unicode, "not implemented"},
        {odd_id_special_case, "not implemented"}
    ]}.

test_basic_header() ->
    case util_curl:http_get(core_server:base_url()++"/test_headers", [{"X-Winamp-Id", "Foo"}]) of 
        {_, {content, "X-Winamp-ID: Foo"}} -> {basic_header, ok};
        {error, R} -> {basic_header, R}
    end.
