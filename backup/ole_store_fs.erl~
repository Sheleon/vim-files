-module(ole_store_fs).
-behaviour(gen_server).
-define(ROOT, "mock_root").

-export([
        mkpath/1,
        start_link/0, init/1, handle_call/3, handle_cast/2, 
        handle_info/2, terminate/2, code_change/3
    ]).

start_link() ->
    gen_server:start_link({local, ?MODULE}, ?MODULE, [], []).

mkpath(Path) ->
    gen_server:call(?MODULE, {mkpath, Path}).

init([]) ->
    {ok, []}.

handle_call({mkpath, Path}, _From, State) ->
    StoredAt = mkpath_recursively(Path, ?ROOT, 1),
    {reply, StoredAt, State}.
%handle_call({mkpath, Path}, From, State) ->
%    spawn(ole_hss_support, get_item, [From, Id]),
%    {noreply, State}.

handle_cast(_Msg, State) ->
    {noreply, State}.

handle_info(_Info, State) ->
    {noreply, State}.

terminate(_Reason, _State) ->
    ok.

code_change(_OldVsn, State, _Extra) ->
    {ok, State}.

% SLOW, needs to build from bottom up, but this was quick to write
mkpath_recursively(Path, Branch, Depth) ->
    {content, BD} = ole_store_server:get_data(Branch),
    BranchData = binary_to_term(BD),
    Find = string:sub_word(Path,Depth,$/),
    case Find of
        [] -> {stored};
        _ -> 
            NextBranch = case proplists:get_value(Find, BranchData) of 
                undefined ->
                    {stored_location, SL} = ole_store_server:set_data(
                        term_to_binary([{}])
                    ),
                    {{_, _}, {_, _}} = ole_store_server:update_data(
                        term_to_binary(
                            BranchData++[{Find, SL}]
                        ),
                        Branch
                    ),
                    SL;
                Value ->
                    Value
            end,
            mkpath_recursively(Path, NextBranch, Depth+1)
    end.
