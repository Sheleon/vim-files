-module(core_echo).
-behaviour(cowboy_http_handler).
-export([tests/0, init/3, handle/2, terminate/2]).

init({_Any, http}, Req, []) ->
    {ok, Req, undefined}.

handle(Req, State) ->
    Echo = case cowboy_http_req:qs_val(<<"echo">>, Req) of
        {undefined, _} -> <<"no echo querystring parameter sent">>;
        {X, _} -> X
    end,
    
    {ok, Reply} = cowboy_http_req:reply(200, [], [<<"Echo: ">>, Echo], Req),
    {ok, Reply, State}.

terminate(_Req, _State) ->
    ok.

tests() ->
    {tests, [
        test_basic_echo(),
        {max_length_test, "not implemented"},
        {empty_test, "not implemented"},
        {unicode_test, "not implemented"}
    ]}.

test_basic_echo() ->
    case util_curl:http_get(core_server:base_url()++"/echo?echo=foo") of 
        {_, {content, "Echo: foo"}} -> {basic_echo, ok};
        {error, R} -> {basic_echo, R}
    end.
